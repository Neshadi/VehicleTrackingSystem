pipeline {
    agent { label 'your-agent-label' } // Replace with the label of your agent
    
    environment {
        // Define any global environment variables here, such as Docker Hub credentials
        DOCKER_USER = 'hirunika'
        DOCKER_PASS = credentials('test-dockerpass')  // Using Jenkins credentials for Docker login
    }
    
    stages { 
        stage('SCM Checkout') {
            steps {
                retry(3) {
                    git branch: 'master', url: 'https://github.com/Neshadi/VehicleTrackingSystem.git'
                }
            }
        }

        stage('Build and Push Docker Images') {
            steps {
                script {
                    // Build first image (server) without version tag
                    sh "docker build -t ${DOCKER_USER}/server-image -f Dockerfileserver ."

                    // Build second image (client) without version tag
                    sh "docker build -t ${DOCKER_USER}/client-image -f Dockerfileclient ."
                }
            }
        }

        stage('Login to Docker Hub') {
            steps {
                script {
                    // Login to Docker Hub using credentials stored in Jenkins
                    sh "echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin"
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    // Push images without version tag
                    sh "docker push ${DOCKER_USER}/server-image"
                    sh "docker push ${DOCKER_USER}/client-image"
                }
            }
        }
    }

    post {
        always {
            // Logout of Docker after the build is complete
            sh 'docker logout'
        }
    }
}
